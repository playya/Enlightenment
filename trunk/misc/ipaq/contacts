#!/usr/bin/perl

# A simple contact manager / calander for the ipaq
# Copyright 2001 Geoff 'Mandrake' Harrison <mandrake@mandrake.net>
# All Rights Reserved
# http://mandrake.net

use Gtk;
use Gtk::Atoms;
use Gtk::Keysyms;

init Gtk;

$last_row = -1;
$prefs{hide_complete_todo} = 1;
$prefs{show_details} = 0;

sub exit_application {

	open TODOLIST, ">$ENV{HOME}/.contacts/todo";
	foreach(@todolist) {
		my %item = %$_;
		chomp $item{startdate};
		chomp $item{enddate};
		print TODOLIST
			"$item{text}::$item{startdate}::$item{enddate}::$item{priority}\n";
	}
	close TODOLIST;
	open NOTESFILE, ">$ENV{HOME}/.contacts/notes";
	print NOTESFILE $notes_text->get_chars(0,$notes_text->get_length);
	close NOTESFILE;
	Gtk->exit(0);
}

sub selected_contact {

	my($widget,$row,$col,$event) = @_;  

	if($last_row == $row) {
		$notebook->set_page(4);
		return;
	}
	$last_row = $row;

}

sub toggle_show_details {

}

sub toggle_show_completed {
	if($prefs{hide_complete_todo}) {
		$prefs{hide_complete_todo} = 0;
		foreach(@todolist) {
			my %item = %$_;
			$item{checkbox}->show();
		}
	} else {
		$prefs{hide_complete_todo} = 1;
		foreach(@todolist) {
			my %item = %$_;
			if($item{enddate} ne "") {
				$item{checkbox}->hide();
			} else {
				$item{checkbox}->show();
			}
		}
	}

}

sub add_new_todo {

	$todo{text}->set_text("");
	$todo{startdate}->set_text(`date`);
	$todo{priority}->set_text("3");
	$notebook->set_page(5);
	$todo{text}->grab_focus();

}

sub toggle_todo_item {
	my($widget, $item) = @_;

	if($$item{enddate} ne "") {
		$$item{enddate} = "";
	} else {
		$$item{enddate} = `date`;
		if($prefs{hide_complete_todo}) {
			$$item{checkbox}->hide();
		}
	}

}

sub toggle_show_details {
	if(!$prefs{show_details}) {
		$prefs{show_details} = 1;
		foreach(@todolist) {
			my $item = $_;
			$$item{checkbox}->destroy;
			$$item{checkbox} = new Gtk::CheckButton;
		   	my $label = new Gtk::Label "$$item{text}\nstarted: $$item{startdate}\nended:$$item{enddate}\nPriority: $$item{priority}";
			$label->show();
			$$item{checkbox}->add($label);
			$label->set_alignment(0,0);
			$todo{vbox}->pack_start($$item{checkbox},0,0,3);
			if($prefs{hide_complete_todo}) {
				if($$item{enddate} ne "") {
					$$item{checkbox}->hide();
				} else {
					$$item{checkbox}->show();
				}
			} else {
				$$item{checkbox}->show();
			}
			if($$item{enddate} ne "") {
				$$item{checkbox}->set_active(1);
			}
			$$item{checkbox}->signal_connect('toggled',\&toggle_todo_item,$item);
		}
	} else {
		$prefs{show_details} = 0;
		foreach(@todolist) {
			my $item = $_;
			$$item{checkbox}->destroy;
			$$item{checkbox} = new Gtk::CheckButton "$$item{text}";
			$todo{vbox}->pack_start($$item{checkbox},0,0,3);
			if($prefs{hide_complete_todo}) {
				if($$item{enddate} ne "") {
					$$item{checkbox}->hide();
				} else {
					$$item{checkbox}->show();
				}
			} else {
				$$item{checkbox}->show();
			}
			if($$item{enddate} ne "") {
				$$item{checkbox}->set_active(1);
			}
			$$item{checkbox}->signal_connect('toggled',\&toggle_todo_item,$item);
		}
	}

}

sub add_new_todo_item {

	my %item;
	$item{text} = $todo{text}->get_text();
	$item{startdate} = $todo{startdate}->get_text();
	$item{enddate} = $todo{enddate}->get_text();
	$item{priority} = $todo{priority}->get_text();
	$item{checkbox} = new Gtk::CheckButton "$item{text}";
	$todo{vbox}->pack_start($item{checkbox},0,0,3);
	if(($item{enddate} ne "") && $prefs{hide_complete_todo}) {
		$item{checkbox}->set_active(1);
	} else {
		$item{checkbox}->show();
	}
	$item{checkbox}->signal_connect('toggled',\&toggle_todo_item, \%item);
	push @todolist,\%item;

	$notebook->set_page(2);

}

sub create_contacts_page {

	my $page = new Gtk::VBox(0,0);
	
	my $scrolled_window = new Gtk::ScrolledWindow(undef,undef);
	$scrolled_window->set_policy('never','always');
	$page->pack_start($scrolled_window,1,1,0);
	$scrolled_window->show();

	my $clist = new_with_titles Gtk::CList("Name","Number");
	$scrolled_window->add($clist);
	$clist->show();
	$clist->set_selection_mode('extended');
	$clist->signal_connect('select-row',\&selected_contact);

# This is some test data

	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->append("Geoff Harrison","412-555-1212");
	$clist->columns_autosize();

# end test data

	my $hbox = new Gtk::HBox(0,0);
	$page->pack_start($hbox,0,1,0);
	$hbox->show();

	my $button = new Gtk::Button "Add";
	$hbox->pack_start($button,1,1,0);
	$button->show();

	$button = new Gtk::Button "Delete";
	$hbox->pack_start($button,1,1,0);
	$button->show();

	$button = new Gtk::Button "Prefs";
	$hbox->pack_start($button,1,1,0);
	$button->show();

	$page->show();
	return $page;
}

sub create_calendar_page {

	my $page = new Gtk::VBox(0,0);
	
	my $scrolled_window = new Gtk::ScrolledWindow(undef,undef);

	$str = `cal`;
	chomp($str);
	my $label = new Gtk::Label $str;
	$page->pack_start($label,1,1,0);
	$label->show();

	$page->show();
	return $page;
}

sub create_todo_page {

	my $page = new Gtk::VBox(0,0);
	
	my $scrolled_window = new Gtk::ScrolledWindow(undef,undef);
	$scrolled_window->set_policy('never','always');
	$page->pack_start($scrolled_window,1,1,0);
	$scrolled_window->show();

	my $vbox = new Gtk::VBox(0,0);
	$scrolled_window->add_with_viewport($vbox);
	$vbox->show();

	open TODOLIST,"$ENV{HOME}/.contacts/todo";
	while(<TODOLIST>) {
		my %todoitem;
		chomp;
		($todoitem{text},$todoitem{startdate},$todoitem{enddate},$todoitem{priority})
			= split /\:\:/;
		if($prefs{show_details}) {
			$todoitem{checkbox} = new Gtk::CheckButton;
		   	my $label = new Gtk::Label "$todoitem{text}\nstarted: $todoitem{startdate}\nended:$todoitem{enddate}\nPriority: $todoitem{priority}";
			$label->show();
			$todoitem{checkbox}->add($label);
			$label->set_alignment(0,0);
		} else {
			$todoitem{checkbox} = new Gtk::CheckButton $todoitem{text};
		}
		$vbox->pack_start($todoitem{checkbox},0,0,3);
		$todoitem{checkbox}->can_focus(0);
		if(($todoitem{enddate} ne "") && $prefs{hide_complete_todo}) {
			$todoitem{checkbox}->set_active(1);
		} else {
			$todoitem{checkbox}->show();
		}
		$todoitem{checkbox}->signal_connect('toggled',\&toggle_todo_item,\%todoitem);

		push @todolist, \%todoitem;

	}
	close TODOLIST;

	$todo{vbox} = $vbox;

	my $hbox = new Gtk::HBox(0,0);
	$page->pack_start($hbox,0,1,0);
	$hbox->show();

	my $button = new Gtk::Button "Add";
	$hbox->pack_start($button,1,1,0);
	$button->show();
	$button->signal_connect('clicked', \&add_new_todo);

	$button = new Gtk::ToggleButton "Details";
	$hbox->pack_start($button,1,1,0);
	$button->show();
	$button->signal_connect('clicked', \&toggle_show_details);

	$button = new Gtk::ToggleButton "View Completed";
	$hbox->pack_start($button,1,1,0);
	$button->show();
	$button->signal_connect('clicked', \&toggle_show_completed);

	$page->show();
	return $page;
}

sub create_notes_page {

	my $page = new Gtk::VBox(0,0);
	
	my $scrolled_window = new Gtk::ScrolledWindow(undef,undef);
	$scrolled_window->set_policy('never','always');
	$page->pack_start($scrolled_window,1,1,0);
	$scrolled_window->show();

	$notes_text = new Gtk::Text;
	$notes_text->set_word_wrap(0);
	$notes_text->show();
	$notes_text->set_editable(1);
	$scrolled_window->add($notes_text);

	if(-e "$ENV{HOME}/.contacts/notes") {
		open NOTESFILE, "<$ENV{HOME}/.contacts/notes";
		while(<NOTESFILE>) {
			$notes_text->insert(undef,$notes_text->style->black,undef,$_);
		}
		close NOTESFILE;
	}
	$page->show();
	return $page;
}

sub create_contact_detail_page {

	my $page = new Gtk::VBox(0,0);
	
	my $scrolled_window = new Gtk::ScrolledWindow(undef,undef);
	$scrolled_window->set_policy('never','always');
	$page->pack_start($scrolled_window,1,1,0);
	$scrolled_window->show();

	my $button = new Gtk::Button "Return to Contact List";
	$page->pack_start($button,0,1,0);
	$button->show();
	$button->signal_connect('clicked', sub { $notebook->set_page(0); });

	$page->show();
	return $page;
}

sub create_new_todo_page {
	my $page = new Gtk::VBox(0,0);
	
	my $table = new Gtk::Table(2,2,0);
	$page->pack_start($table,1,1,0);
	$table->show();

	my $label = new Gtk::Label "Todo: ";
	$label->set_alignment(1,1);
	$table->attach($label,0,1,0,1,[-fill],0,0,0);
	$label->show();

	$todo{text} = new Gtk::Entry;
	$table->attach($todo{text},1,2,0,1,[-expand,-fill],[-fill],0,0);
	$todo{text}->show();

	$label = new Gtk::Label "Date Added: ";
	$label->set_alignment(1,1);
	$table->attach($label,0,1,1,2,[-fill],0,0,0);
	$label->show();

	$todo{startdate} = new Gtk::Entry;
	$table->attach($todo{startdate},1,2,1,2,[-expand,-fill],[-fill],0,0);
	$todo{startdate}->show();

	$label = new Gtk::Label " Date Completed: ";
	$label->set_alignment(1,1);
	$table->attach($label,0,1,2,3,[-fill],0,0,0);
	$label->show();

	$todo{enddate} = new Gtk::Entry;
	$table->attach($todo{enddate},1,2,2,3,[-expand,-fill],[-fill],0,0);
	$todo{enddate}->show();

	$label = new Gtk::Label " Priority: ";
	$label->set_alignment(1,1);
	$table->attach($label,0,1,3,4,[-fill],0,0,0);
	$label->show();

	$todo{priority} = new Gtk::Entry;
	$table->attach($todo{priority},1,2,3,4,[-expand,-fill],[-fill],0,0);
	$todo{priority}->show();

	my $hbox = new Gtk::HBox(0,0);
	$page->pack_start($hbox,0,1,0);
	$hbox->show();

	my $button = new Gtk::Button "Add This Item";
	$hbox->pack_start($button,1,1,0);
	$button->show();
	$button->signal_connect('clicked', \&add_new_todo_item);

	$button = new Gtk::Button "Cancel";
	$hbox->pack_start($button,1,1,0);
	$button->signal_connect('clicked', sub { $notebook->set_page(2);});
	$button->show();

	$page->show();
	return $page;
}

sub create_main_window {
	my $main_vbox = new Gtk::VBox(0,0);
	$main_vbox->show();

	my $omenu = new Gtk::OptionMenu;
	my $menu  = new Gtk::Menu;

	$omenu->set_menu($menu);
	$omenu->show();
	$menu->show();

	my $menuitem = new Gtk::MenuItem("Contacts");
	$menuitem->signal_connect('activate', sub { $notebook->set_page(0); });
	$menuitem->show();
	$menu->append($menuitem);
	$omenu->set_history(0);

	$menuitem = new Gtk::MenuItem("Calendar");
	$menuitem->signal_connect('activate', sub { $notebook->set_page(1); });
	$menuitem->show();
	$menu->append($menuitem);

	$menuitem = new Gtk::MenuItem("Todo List");
	$menuitem->signal_connect('activate', sub { $notebook->set_page(2); });
	$menuitem->show();
	$menu->append($menuitem);

	$menuitem = new Gtk::MenuItem("Notes");
	$menuitem->signal_connect('activate', sub { $notebook->set_page(3);
			$notes_text->grab_focus();});
	$menuitem->show();
	$menu->append($menuitem);

	$main_vbox->pack_start($omenu,0,1,0);

	$notebook = new Gtk::Notebook;
	$notebook->append_page(create_contacts_page());
	$notebook->append_page(create_calendar_page());
	$notebook->append_page(create_todo_page());
	$notebook->append_page(create_notes_page());
	$notebook->append_page(create_contact_detail_page());
	$notebook->append_page(create_new_todo_page());
	$notebook->show();
	$notebook->set_show_border(0);
	$notebook->set_show_tabs(0);
	$main_vbox->pack_start($notebook,1,1,0);

	return $main_vbox;
}

if(!(-e "$ENV{HOME}/.contacts")) {
	mkdir "$ENV{HOME}/.contacts", 0700;
}
$main_window = new Gtk::Window '-toplevel';
$main_window->set_title("Personal Information Manager");
$main_window->set_policy(1,1,0);

$main_window->add(create_main_window());

$main_window->signal_connect('destroy',\&exit_application);
$main_window->signal_connect('delete_event',\&exit_application);

$main_window->show();

Gtk->main();
