From 5dbb443b609dbc314732ff1fecf47607ca2d671a Mon Sep 17 00:00:00 2001
From: Carsten Haitzler <raster@openmoko.org>
Date: Tue, 14 Apr 2009 20:32:39 +1000
Subject: [PATCH] xserver-kdrive-common: fix Xserver script to properly choose background PPM

---
 .../xserver-kdrive-common/Xserver                  |   41 ++++++++++++++---
 .../xserver-kdrive-common/openmoko/Xserver         |   49 +++++++++++++++-----
 2 files changed, 71 insertions(+), 19 deletions(-)

diff --git a/recipes/xserver-kdrive-common/xserver-kdrive-common/Xserver b/recipes/xserver-kdrive-common/xserver-kdrive-common/Xserver
index 76a09b5..f6f5943 100644
--- a/recipes/xserver-kdrive-common/xserver-kdrive-common/Xserver
+++ b/recipes/xserver-kdrive-common/xserver-kdrive-common/Xserver
@@ -41,7 +41,8 @@ export USER=root
 
 SCREEN_SIZE=`fallback_screen_arg`
 
-ARGS=" -br -pn"
+ARGS=" -pn"
+PPM=" -br"
 
 # use ucb 1x00 touchscreen if present
 if [ -z "$TSLIB_TSDEVICE" ] && [ -e /dev/touchscreen/ucb1x00 ]; then
@@ -104,18 +105,30 @@ case `module_id` in
                 ARGS="$ARGS -fb /dev/fb1" ;;
         "GTA01")
                 if [ `screen_width` -gt 330 ] ; then
+                     if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                     fi
                      DPI=285
                 else
-                     DPI=140
+                     if [ -f "/usr/share/pixmaps/xsplash-qvga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga.ppm"
+                     fi
+                     DPI=142
                 fi 
-                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib" ;;
+                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor ${PPM} vt1" ;;
        "GTA02")
                 if [ `screen_width` -gt 330 ] ; then
+                     if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                     fi
                      DPI=285
                 else 
-                     DPI=140
+                     if [ -f "/usr/share/pixmaps/xsplash-qvga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga.ppm"
+                     fi
+                     DPI=142
                 fi 
-                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib" 
+                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor ${PPM} vt1" 
 		XSERVER=/usr/bin/Xglamo 
 		;;
 	"Nokia N770")
@@ -125,14 +138,28 @@ case `module_id` in
                 ARGS="$ARGS -dpi 225 -screen ${SCREEN_SIZE} -mouse tslib" 
                 XSERVER=/usr/bin/Xomap ;;
 	"Palm Treo 650")
-		ARGS="$ARGS -dpi 181 -screen 320x320 -hide-cursor" ;;
+                if [ -f "/usr/share/pixmaps/xsplash-qvga-square.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga-square.ppm"
+                fi
+                ARGS="$ARGS -dpi 181 -screen 320x320 -mouse tslib -hide-cursor ${PPM}" ;;
         "Motorola Ezx Platform")
+                if [ -f "/usr/share/pixmaps/xsplash-qvga.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga.ppm ${PPM}"
+                fi
                 ARGS="$ARGS -dpi 170 -screen ${SCREEN_SIZE}" ;;
 	"Glofiish M800")
-                ARGS="$ARGS -dpi 285 -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor" ;;
+                if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                fi
+                ARGS="$ARGS -dpi 285 -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor ${PPM} vt1" ;;
         "Freescale MX21ADS")
 	# That's what /proc/cpuinfo shows as hardware on the chumby
                  ARGS="$ARGS -dpi 121 -screen 320x240 -hide-cursor -mouse tslib" ;;
+        "OMAP3 Beagle Board")
+                 ARGS="$ARGS ${PPM}"
+# 32bpp - we'll enable it once newer kernels are.. working.                 
+#                 ARGS="$ARGS -fbbpp32"
+                 XSERVER=/usr/bin/Xorg ;;
         *)
                 # It is a device we do not know about, in which case we force
                 # kdrive to use the current framebuffer geometry -- otherwise
diff --git a/recipes/xserver-kdrive-common/xserver-kdrive-common/openmoko/Xserver b/recipes/xserver-kdrive-common/xserver-kdrive-common/openmoko/Xserver
index 7c70b2f..3ad9747 100644
--- a/recipes/xserver-kdrive-common/xserver-kdrive-common/openmoko/Xserver
+++ b/recipes/xserver-kdrive-common/xserver-kdrive-common/openmoko/Xserver
@@ -40,8 +40,8 @@ module_id() {
 export USER=root
 
 SCREEN_SIZE=`fallback_screen_arg`
-
-ARGS=" -br -pn"
+PPM="-br"
+ARGS=" -pn"
 
 # use ucb 1x00 touchscreen if present
 if [ -z "$TSLIB_TSDEVICE" ] && [ -e /dev/touchscreen/ucb1x00 ]; then
@@ -102,18 +102,30 @@ case `module_id` in
                 ARGS="$ARGS -fb /dev/fb1" ;;
         "GTA01")
                 if [ `screen_width` -gt 330 ] ; then
+                     if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                     fi
                      DPI=285
                 else
+                     if [ -f "/usr/share/pixmaps/xsplash-qvga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga.ppm"
+                     fi
                      DPI=140
                 fi 
-                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor -root-ppm /usr/share/pixmaps/xsplash-vga.ppm vt1" ;;
+                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor ${PPM} vt1" ;;
        "GTA02")
                 if [ `screen_width` -gt 330 ] ; then
+                     if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                     fi
                      DPI=285
                 else 
+                     if [ -f "/usr/share/pixmaps/xsplash-qvga.ppm" ]; then
+                          PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga.ppm"
+                     fi
                      DPI=140
                 fi 
-                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor -root-ppm /usr/share/pixmaps/xsplash-vga.ppm vt1" 
+                ARGS="$ARGS -dpi ${DPI} -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor ${PPM} vt1"
 		XSERVER=/usr/bin/Xglamo 
 		;;
 	"Nokia N770")
@@ -123,18 +135,31 @@ case `module_id` in
                 ARGS="$ARGS -dpi 225 -screen ${SCREEN_SIZE} -mouse tslib" 
                 XSERVER=/usr/bin/Xomap ;;
         "Palm Treo 650")
-	        if [ -f "/usr/share/pixmaps/xsplash-qvga-square.ppm" ]; then
-		  PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga-square.ppm"
-		fi
-                ARGS="$ARGS -dpi 181 -screen 320x320 -hide-cursor $PPM" ;;
+                if [ -f "/usr/share/pixmaps/xsplash-qvga-square.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga-square.ppm"
+                fi
+                ARGS="$ARGS -dpi 181 -screen 320x320 -hide-cursor ${PPM}" ;;
         "Motorola Ezx Platform")
-                ARGS="$ARGS -dpi 170 -screen ${SCREEN_SIZE} -hide-cursor -mouse tslib -root-ppm /usr/share/pixmaps/xsplash-qvga.ppm vt1" ;;
+                if [ -f "/usr/share/pixmaps/xsplash-qvga.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-qvga.ppm"
+                fi
+                ARGS="$ARGS -dpi 170 -screen ${SCREEN_SIZE} -hide-cursor -mouse tslib ${PPM} vt1" ;;
         "Glofiish M800")
-                ARGS="$ARGS -dpi 285 -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor -root-ppm /usr/share/pixmaps/xsplash-vga.ppm vt1" ;;
+                if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                fi
+                ARGS="$ARGS -dpi 285 -screen ${SCREEN_SIZE} -mouse tslib -hide-cursor ${PPM} vt1" ;;
         "Freescale MX21ADS")
          # That's what /proc/cpuinfo shows as hardware on the chumby
-                ARGS="$ARGS -dpi 121 -screen 320x240 -hide-cursor -mouse tslib -root-ppm /usr/share/pixmaps/xsplash-qvga.ppm vt1" ;;
-
+                if [ -f "/usr/share/pixmaps/xsplash-vga.ppm" ]; then
+                     PPM="-root-ppm /usr/share/pixmaps/xsplash-vga.ppm"
+                fi
+                ARGS="$ARGS -dpi 121 -screen 320x240 -hide-cursor -mouse tslib ${PPM} vt1" ;;
+        "OMAP3 Beagle Board")
+                ARGS="$ARGS -br"
+# 32bpp - we'll enable it once newer kernels are.. working.
+#                 ARGS="$ARGS -fbbpp32"
+                XSERVER=/usr/bin/Xorg ;;
         *)
                 # It is a device we do not know about, in which case we force
                 # kdrive to use the current framebuffer geometry -- otherwise
-- 
1.5.6.3

