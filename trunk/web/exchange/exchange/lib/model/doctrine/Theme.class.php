<?php

/**
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class Theme extends BaseTheme
{
	public static function getByName($name) {
		$q = new Doctrine_Query();
		return $q->select('t.*')
					->from('Theme t')
					->where('name = ?', array($name))
					->fetchOne();
	}
	
	public function getFolderPath()
	{
		if (sfConfig::get('sf_environment') == 'prod')
			return sfConfig::get('sf_root_dir').DIRECTORY_SEPARATOR.'..'.DIRECTORY_SEPARATOR.'html'.DIRECTORY_SEPARATOR.'files'.DIRECTORY_SEPARATOR.'theme'.DIRECTORY_SEPARATOR.$this->getId().DIRECTORY_SEPARATOR;
		else
			return sfConfig::get('sf_root_dir').DIRECTORY_SEPARATOR.'web'.DIRECTORY_SEPARATOR.'files'.DIRECTORY_SEPARATOR.'theme'.DIRECTORY_SEPARATOR.$this->getId().DIRECTORY_SEPARATOR;
	}
	
	public function getUrlPath()
	{
		return '/files/theme/'.$this->getId().'/';
	}
	
	public function getShowPath()
	{
		return '/theme/show/'.$this->getId();
	}
	
	public function getXML($rss = false)
	{
		if ($rss) {
			$output = 	'<item>' .
							'<title>'.htmlspecialchars($this->getName()).'</title>' .
							'<link>'.htmlspecialchars(Tools::get('url').'/theme/show/'.$this->getId()).'</link>' .
							'<description>'.
								htmlspecialchars('	<a href="'.Tools::get('url').'/theme/get/'.$this->getId().'">' .
														'<img src="'.Tools::get('url').$this->getUrlPath().'smallthumb.png" alt="Thumbnail">' .
													'</a><br/>'.
												$this->getDescription()).'</description>' .
							'<pubDate>'.date('r', strtotime($this->getUpdatedAt())).'</pubDate>' .
							'<guid>'.htmlspecialchars(Tools::get('url').'/theme/show/'.$this->getId()).'</guid>' .
						'</item>';
		} else {
			$output = '<theme>';
			$output .= '<id>'.$this->getId().'</id>';
			$output .= '<name>'.htmlspecialchars($this->getName()).'</name>';
			$output .= '<author>'.htmlspecialchars($this->getAuthor()).'</author>';
			$output .= '<license>'.htmlspecialchars($this->getLicense()).'</license>';
			$output .= '<version>'.htmlspecialchars($this->getVersion()).'</version>';
			$output .= '<description>'.htmlspecialchars($this->getDescription()).'</description>';
			$output .= '<url>'.htmlspecialchars(Tools::get('url').'/theme/get/'.$this->getId()).'</url>';
			$output .= '<thumbnail>'.htmlspecialchars(Tools::get('url').$this->getUrlPath().'smallthumb.png').'</thumbnail>';
			$output .= '<screenshot>'.htmlspecialchars(Tools::get('url').$this->getUrlPath().'screenshot.png').'</screenshot>';
			$output .= '<rating>'.$this->getRating().'</rating>';
			$output .= '<user_id>'.$this->getUserId().'</user_id>';
			$output .= '<created_at>'.$this->getCreatedAt().'</created_at>';
			$output .= '<updated_at>'.$this->getUpdatedAt().'</updated_at>';
			$output .= '</theme>';
		}
		return $output;
	}
	
	public function clearThemeGroups()
	{
		$themeThemeGroups = $this->getThemeThemeGroups();
		foreach ($themeThemeGroups as $themeThemeGroup)
			$themeThemeGroup->delete();
	}
	
	public function addThemeGroup($name)
	{
	  	try {
		  	$name = trim($name);
		  	$q = new Doctrine_Query();
		    $themeThemeGroup = $q->select('tg.*')
		    				->from('ThemeThemeGroup tg, tg.ThemeGroup t')
		    				->addWhere('tg.theme_id = ? and t.name = ?', array($this->getId(), $name))
		    				->fetchOne();
		    if (!$themeThemeGroup) {
		  		$q = new Doctrine_Query();
			    $themeGroup = $q->select('t.*')
			    				->from('ThemeGroup t')
			    				->addWhere('t.name = ?', array($name))
			    				->fetchOne();
			    if (!$themeGroup) {
			    	$themeGroup = new ThemeGroup();
			    	$themeGroup->setName($name);
			    	$themeGroup->save();
			    }
			    $themeThemeGroup = new ThemeThemeGroup();
			    $themeThemeGroup->setThemeGroupId($themeGroup->getId());
			    $themeThemeGroup->setThemeId($this->getId());
			    $themeThemeGroup->save();
		    }
		    return $themeThemeGroup;
	  	} catch (Exception $e) { }
	  	return null;
	}
	
	public function save(Doctrine_Connection $conn = null) {
    	if (!$this->exists()) {
			$this->setCreatedAt(date('Y-m-d H:i:s'));
    	}
    	$modified = $this->getModified();
    	if (!isset($modified['downloads'])&&!isset($modified['rating']))
			$this->setUpdatedAt(date('Y-m-d H:i:s'));
		parent::save($conn);
	}
	
	public function updateRating() {
		$ratings = $this->getRatings();
		$total = 0;
		if (!$ratings->count())
			return 0;
		foreach ($ratings as $rating)
			$total += $rating->getValue();
		$this->setRating($total / $ratings->count());
		$this->save(); 
	}
	
	public static function update($values, $user)
	{
		$id = $values['id'];
		if ($id) {
			$q = new Doctrine_Query();
			$q = $q->select('t.*')
					->from('Theme t');
			$q = $q->addWhere('id = ?', array($id));
			if (!$user->getRole()==User::ADMIN)
				$q = $q->addWhere('user_id = ?', array($user->getId()));
			$theme = $q->fetchOne();
		} else
			$theme = new Theme();
		if ($theme) {
			$theme->setName($values['name']);
			$theme->setDescription($values['description']);
			if (!$theme->getUserId())
			$theme->setUserId($user->getId());
			$file = $values['file'];
			if ($file) {
				$filename = $file->getOriginalName();
				$theme->setFileName($filename);
			}
			$theme->setApproved(false);
			$theme->save();
			$folderpath = $theme->getFolderPath();
			if (!is_dir($folderpath))
				mkdir($folderpath);
			if ($file) {
				$filepath = $folderpath.$theme->getFileName();
				$file->save($filepath);
			}
			$screenshot = $values['screenshot'];
			if ($screenshot) {
				$screenshotpath = $folderpath.$theme->getId().$screenshot->getOriginalName();
				$screenshot->save($screenshotpath);
				$smallThumb = new Thumbnail($screenshotpath);
				if ($smallThumb->getCurrentWidth() > 150 || $smallThumb->getCurrentHeight() > 150)
					$smallThumb->resize(150, 150);
				$smallThumb->show(100, $folderpath.'smallthumb.png');
				$bigThumb = new Thumbnail($screenshotpath);
				if ($bigThumb->getCurrentWidth() > 500 || $bigThumb->getCurrentHeight() > 500)
					$bigThumb->resize(500, 500);
				$bigThumb->show(100, $folderpath.'bigthumb.png');
				$screenshot = new Thumbnail($screenshotpath);
				$screenshot->show(100, $folderpath.'screenshot.png');
				unlink($screenshotpath);
			}
			$outputs = array();
			if ($file) {
				exec(Tools::get('edje_list_path').' '.$filepath, $outputs);
				$groups = array_splice($outputs, 4);
				$groups = array_keys(array_flip($groups));
				$name = substr($outputs[0], 6);
				if ($name)
					$theme->setName($name);
				$author = substr($outputs[1], 8);
				if ($author)
					$theme->setAuthor($author);
				$license = substr($outputs[2], 9);
				$theme->setLicense($license);
				$version = substr($outputs[3], 9);
				$theme->setVersion($version);
				$theme->save();
				$theme->clearThemeGroups();
				foreach ($groups as $group)
					$theme->addThemeGroup($group);
			}
			return $theme;
		}
		return null;
	}
}
