<?php
//******* SET THIS TO YOUR e/devs DIRECTORY  ********
$cvs_dir="/var/www/web/devs";
//***************************************************

if (!is_dir($cvs_dir))
{
   echo "<div align=center><b>ERROR: can't find cvs devs directory path.</b></div>";
   exit();
}

function
GetValueFromInfoFile($field, $InfoFile)
{
   if ($i=eregi("$field:[ \t]*([ ,@.:/~()!a-zA-Z0-9_-]*)", "$InfoFile", $result))
      return trim($result[1]);
   else return "";
}

$devs = array();

/* loop the 'devs/' dir and parse every info.txt files */
if ($dh = opendir($cvs_dir))
{
   $i = 0;
   while (($file = readdir($dh)) !== false)
   {
      if (is_dir("$cvs_dir/$file") AND
          file_exists("$cvs_dir/$file/info.txt"))
      {
         /* get user info from info.txt file */
         $txt = file_get_contents("$cvs_dir/$file/info.txt");
         $Coords = GetValueFromInfoFile("GeoData", $txt); 
         $Location = GetValueFromInfoFile("Location", $txt);
         $IRC =  GetValueFromInfoFile("IRC Nick", $txt);

         /* skip user without a nickname*/
         if (!$IRC OR $IRC == "N/A")
            continue;

         /* parse GeoData fields*/
         $lat = $lon = 0;
         $Coords = explode(" ",$Coords);
         if($Coords && (count($Coords) == 2))
         {
            $tot_geodata ++;
            $lat = floatval($Coords[0]);
            $lon = floatval($Coords[1]);
         }

         /* create an array entry for this developer */
         if (($lat AND $lon) OR ($Location))
         {
            $devs[$i]["IRC"] = $IRC;
            $devs[$i]["lat"] = $lat;
            $devs[$i]["lon"] = $lon;
            $devs[$i]["Location"] = $Location;
            $devs[$i]["Name"] = GetvalueFrominfoFile("Name", $txt);
            $devs[$i]["Email"] = GetvalueFrominfoFile("E-Mail", $txt);
            if ($devs[$i]["Email"][0] == '-') $devs[$i]["Email"] = ""; 
            $devs[$i]["WWW"] = GetValueFromInfoFile("WWW", $txt);
            $devs[$i]["Managing"] = GetValueFromInfoFile("Managing", $txt);
            $devs[$i]["Contributing"] = GetValueFromInfoFile("Contributing", $txt);
            $devs[$i]["Group"] = GetValueFromInfoFile("Group", $txt);
            $devs[$i]["Platform"] = GetValueFromInfoFile("Platform", $txt );

            /* choose the user icon (icon-map.png, green or red) */ 
            if (file_exists("$cvs_dir/$file/icon-map.png"))
               $devs[$i]["Icon"] =
                  "http://download.enlightenment.org/devs/$file/icon-map.png";
            elseif ($lat AND $lon)
               $devs[$i]["Icon"] =
                  "http://labs.google.com/ridefinder/images/mm_20_green.png";
            else
               $devs[$i]["Icon"] =
                  "http://labs.google.com/ridefinder/images/mm_20_red.png";

            /* check the user image (icon-med.png) */
            if (file_exists("$cvs_dir/$file/icon-med.png"))
               $devs[$i]["IconBig"] =
                  "http://download.enlightenment.org/devs/$file/icon-med.png";
            else
               $devs[$i]["IconBig"] = "";
 
            $i ++;
         }
      }
   }
}
/*** DEBUG ***/
//print "<pre>"; print_r($devs); print "</pre>";
/******************************************************************************/
?>

<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="ClusterMarker.js"></script>

<style type="text/css">
   html { height: 100% }
   body { height: 100% }
   #map_canvas { height: 500px; width: 100% }
   #map_table { width: 100%; font-size: 12px; border: 1px solid black }
   .infowin td { font-size: 12px }
   #sidebar { height: 500px; overflow-y: scroll }
   #sidebar a { display: block }
   #totals { float: right; font-size: 12px; margin-right: 5px }
   #coords { float: left; font-size: 12px; margin-left: 5px }
</style>

<center><h1>Enlightenment Developers World Map</h1></center>
<p>This map shows, in a geographical way, the information of all the people
having a svn account. The information is taken directly from the info.txt file
in svn. The green markers are the developers that have a 'GeoData' field in
their file, on the other side the position of the red one is guessed from
the 'Location' field, and will not be as accurate.</p>
<p>Clicking on a marker will open a popup showing all the information about
a specific developer (contacts, in which project is involved and the used
platform). With the control on the left you can zoom, pan and recenter as
you wish.
</p>

<div id="coords">Coords:</div>
<div  id="totals">Total devs: 0 (0 guessed)</div>
<table id="map_table" border=0>
   <tr>
      <td><div id="sidebar"></div></td>
      <td width="100%"><div id="map_canvas"></div></td>
   </tr>
</table>


<script type="text/javascript">
/******************************************************************************/
/* Initialize map canvas */
var canvas = document.getElementById("map_canvas")
var map = new google.maps.Map(canvas, {
      zoom: 2,
      center: new google.maps.LatLng(26, 0),
      mapTypeId: google.maps.MapTypeId.SATELLITE
    })
var infowin = new google.maps.InfoWindow()
var geocoder = new google.maps.Geocoder()
var tot_geodata = 0
var tot_location = 0
var tot_error = 0

/* on mouse-move update the coords div */
google.maps.event.addListener(map, 'mousemove', function(event) {
      update_lat_lon(event.latLng);
   });

/* Place all the markers (from the php array)*/
<?php 
foreach ($devs as $dev)
   echo "create_dev_marker($dev[lat], $dev[lon], '$dev[IRC]', '$dev[Location]',
                  '$dev[Icon]', '$dev[IconBig]', '$dev[Name]', '$dev[Email]',
                  '$dev[WWW]', '$dev[Managing]', '$dev[Contributing]',
                  '$dev[Platform]', '$dev[Group]')\n";   
?>

/* Create a new developer marker */
function
create_dev_marker(lat, lon, IRC, Location, Icon, IconBig, Name, Email, WWW,
                  Managing, Contributing, Platform, Group)
{
   /* set icons sizes */
   if (Icon.match("icon-map.png$") == "icon-map.png")
      var icon = new google.maps.MarkerImage(Icon,
         new google.maps.Size(22, 29),  // icon size
         new google.maps.Point(0,0),    // icon origin point
         new google.maps.Point(11, 29))  // icon anchor point
   else
      var icon = new google.maps.MarkerImage(Icon,
         new google.maps.Size(12, 20),  // icon size
         new google.maps.Point(0,0),    // icon origin point
         new google.maps.Point(6, 20))  // icon anchor point
 
   var shadow = new google.maps.MarkerImage(
         'http://labs.google.com/ridefinder/images/mm_20_shadow.png',
         new google.maps.Size(22, 20),  // shadow size
         new google.maps.Point(0,0),    // shadow origin point
         new google.maps.Point(6, 20))  // shadow anchor point

   /* create infowindow html content */
   var html = ""
   html += '<div class="infowin">'
   html += '<table><tr>'
   if (IconBig)      html += '<td><img src="' + IconBig + '"></td>'
                     html += '<td><h3>' + IRC
   if (Name)         html += ' (' + Name + ')'
                     html += '</h3>'
   if (Email)        html += Email
   if (Email && WWW) html += ' - '
   if (WWW)          html += '<a href="' + WWW + '">' + WWW + '</a>'
                     html += '<br>'
   if (Managing)     html += '<b>Managing:</b> ' + Managing + '<br>'
   if (Contributing) html += '<b>Contributing:</b> ' + Contributing + '<br>'
   if (Group)        html += '<b>Group:</b> ' + Group + '<br>'
   if (Platform)     html += '<b>Platform:</b> ' + Platform + '<br>'
   if (Location)     html += '<b>Location:</b> ' + Location + '<br>'
   html += '</td></tr></table>'
   html += '</div>'

   /* create the marker from the GeoData field */
   if (lat != 0 && lon != 0)
   {
      var latlng = new google.maps.LatLng(lat, lon)
      tot_geodata ++
      update_totals()
      create_dev_marker_real(false, latlng, icon, shadow,IRC, Location, html)
   }
   else if (Location)
   {
      /* no, geodata, use google geocoder to guess the position */
      geocoder.geocode({ 'address': Location }, function(results, status) {
         if (status == google.maps.GeocoderStatus.OK)
         {
            var latlng = results[0].geometry.location
            tot_location ++
            create_dev_marker_real(true, latlng, icon, shadow, IRC, Location, html)
            update_totals()
         }
         else
         {
            //alert ("ERROR: " + status)
            tot_error++
         }
      })

      /* use static HTTP geocoder, it has less limits than the js API */
      /*var url = 'http://maps.google.com/maps/api/geocode/json?address=milano,italia&sensor=false'
      var my_JSON_object = {}; 
      var http_request = new XMLHttpRequest();
      http_request.open( "GET", url, true );
      http_request.onreadystatechange = function () {
            if (http_request.readyState == 4 && http_request.status == 200)
            {
               my_JSON_object = JSON.parse( http_request.responseText );
               alert("DONE")
            }
         };
      http_request.send();*/
   }
   update_totals()
}

function
create_dev_marker_real(guessed, latlng, icon, shadow, IRC, Location, html)
{
   var marker = new google.maps.Marker({
         position: latlng,
         title: IRC,
         map: map,
         icon: icon,
         shadow: shadow
       })

   google.maps.event.addListener(marker, 'click', function() {
         show_infowin(marker, html)
       })

   sidebar_add_entry(IRC, marker, html)
}

function
show_infowin(marker, html)
{
   infowin.setContent(html)
   infowin.open(map, marker)
}

function
sidebar_add_entry(IRC, marker, html)
{
   var newlink = document.createElement('a')
   newlink.onclick = function() { show_infowin(marker, html); return false; }
   newlink.innerHTML = IRC
   newlink.setAttribute('href', '#');
   var sidebar = document.getElementById("sidebar")
   sidebar.appendChild(newlink)
}

function
update_lat_lon(latLng)
{
   var coords_div = document.getElementById("coords")
   var coords = "Coords: " + latLng.toUrlValue(5)
   coords_div.innerHTML = coords.replace(",", " ")
}

function
update_totals()
{
   var total = document.getElementById('totals')
   total.innerHTML = 'Total devs: ' + (tot_geodata+tot_location) +
                     ' (' + tot_location + ' guessed) [ERR: '+tot_error+']'
}

</script>
